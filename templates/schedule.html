<!DOCTYPE html>
<html>
<head>
    <title>MIAC Автовыгрузка</title>
    <meta charset="utf-8">
    <style>
        body { font-family: Arial; max-width: 800px; margin: 50px auto; padding: 20px; }
        .card { border: 1px solid #ddd; padding: 20px; margin: 20px 0; border-radius: 8px; }
        button { background: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; }
        button:hover { background: #0056b3; }
        .success { background: #d4edda; color: #155724; padding: 10px; border-radius: 5px; }
        select, input { padding: 8px; margin: 5px; border: 1px solid #ddd; border-radius: 4px; }

        /* Стили для сворачиваемого блока - ИСПРАВЛЕНО */
        .collapsible-header {
            cursor: pointer;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 5px;
            margin: -20px -20px 0 -20px; /* Убран нижний отступ (было 20px) */
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: bold;
        }
        .collapsible-content {
            max-height: 1000px;
            overflow: hidden;
            transition: max-height 0.3s ease-out, padding 0.3s ease-out; /* Добавлен переход для padding */
            padding-top: 20px; /* Добавлен отступ сверху для контента */
        }
        .collapsible-content.collapsed {
            max-height: 0;
            padding: 0 !important; /* Полностью убираем отступы при сворачивании */
        }
        .toggle-icon {
            font-size: 18px;
            transition: transform 0.3s;
        }
        .toggle-icon.rotated {
            transform: rotate(90deg);
        }

        /* Уменьшение отступа у заголовков в карточках */
        .card h3 {
            margin-top: 0; /* Минимальный верхний отступ */
            margin-bottom: 12px;
        }
    </style>
</head>
<body>
    <h1>MIAC Автовыгрузка талонов</h1>

    <!-- Блок расписания (сворачиваемый) -->
    <div class="card">
        <div class="collapsible-header" onclick="toggleCollapse('schedule-content')">
            <span>Расписание</span>
            <span class="toggle-icon" id="schedule-icon">▼</span>
        </div>
        <div class="collapsible-content" id="schedule-content">
            <form id="scheduleForm">
                <label>Включить автозапуск:</label>
                <input type="checkbox" id="enabled" {{ 'checked' if config.enabled }}>

                <br><br>
                <label>День недели:</label>
                <select id="day">
                    <option value="0" {{ 'selected' if config.day_of_week == 0 }}>Понедельник</option>
                    <option value="1" {{ 'selected' if config.day_of_week == 1 }}>Вторник</option>
                    <option value="2" {{ 'selected' if config.day_of_week == 2 }}>Среда</option>
                    <option value="3" {{ 'selected' if config.day_of_week == 3 }}>Четверг</option>
                    <option value="4" {{ 'selected' if config.day_of_week == 4 }}>Пятница</option>
                    <option value="5" {{ 'selected' if config.day_of_week == 5 }}>Суббота</option>
                    <option value="6" {{ 'selected' if config.day_of_week == 6 }}>Воскресенье</option>
                </select>

                <br><br>
                <label>Время:</label>
                <input type="number" id="hour" min="0" max="23" value="{{ config.hour }}">:
                <input type="number" id="minute" min="0" max="59" value="{{ config.minute }}" style="width:50px">

                <br><br>
                <div style="display: flex; gap: 10px;">
                    <button type="submit" style="flex: 1;">Сохранить расписание</button>
                    <button type="button" id="clearSchedule" style="background: #dc3545; flex: 1;">Удалить расписание</button>
                </div>
            </form>
            <div id="status"></div>
        </div>
    </div>

    <!-- Блок Ручной запуск (остается прежним) -->
    <div class="card">
        <h3>Ручной запуск</h3>
        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
            <a href="/manual"><button style="flex: 1; min-width: 200px;">Запустить выгрузку СЕЙЧАС</button></a>
            <a href="/download-report"><button style="flex: 1; min-width: 200px;">Скачать последний отчет</button></a>
        </div>
    </div>

    <div class="card">
        <h3>Создание отчета</h3>
        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
            <a id="openDashboard" href="#" target="_blank">
                <button style="background: #28a745; padding: 12px 30px; font-size: 16px; margin-right: 10px;">Открыть дашборд</button>
            </a>
            <div style="display:flex;align-items:center;background:#e8f5e9;color:#1b5e20;padding:10px 14px;border-radius:6px;">
                Выгрузка встроена в программу: после авторизации данные автоматически отправляются обратно в сервис.
            </div>
        </div>
        <div style="margin-top:12px; background:#f8f9fa; border-radius:6px; padding:10px 14px; font-size:14px;">
            <b>Как это работает:</b>
            <ol style="margin:8px 0 0 18px; padding:0;">
                <li>Нажмите «Открыть дашборд» — ссылка передаёт callback вашего сервиса.</li>
                <li>Авторизуйтесь на портале Госуслуг.</li>
                <li>После появления дашборда скрипт автоматически начинает сбор данных.</li>
                <li>По завершении данные отправляются в программу в файл <code>parse.json</code>.</li>
            </ol>
        </div>
    </div>




<!--    <div class="card">-->
<!--        <h3>Статус</h3>-->
<!--        <div id="status-info">Загрузка...</div>-->
<!--    </div>-->

    <script>
        // Функция сворачивания/разворачивания
        function toggleCollapse(contentId) {
            const content = document.getElementById(contentId);
            const icon = document.getElementById('schedule-icon'); // Исправлен ID иконки

            content.classList.toggle('collapsed');
            icon.classList.toggle('rotated');
        }

        const dashboardBaseUrl = 'https://info-bi-db.egisz.rosminzdrav.ru/dashboardsViewer?sectionId=27&dashboardId=8d82093225eb470595ae4d49d2edc555&sheetId=75e7b48008b34db482c350b2333e2d45';
        const callbackUrl = `${window.location.origin}/extension/export`;
        document.getElementById('openDashboard').href = `${dashboardBaseUrl}#miac_callback=${encodeURIComponent(callbackUrl)}`;

        // Сохранение расписания
        document.getElementById('scheduleForm').onsubmit = async (e) => {
            e.preventDefault();
            const formData = new FormData();
            formData.append('enabled', document.getElementById('enabled').checked);
            formData.append('day', document.getElementById('day').value);
            formData.append('hour', document.getElementById('hour').value);
            formData.append('minute', document.getElementById('minute').value);

            const resp = await fetch('/schedule', {method: 'POST', body: formData});
            const data = await resp.json();
            document.getElementById('status').innerHTML = `<div class="success">${data.message}</div>`;
        }

        // Загрузка статуса
        async function loadStatus() {
            const resp = await fetch('/status');
            const data = await resp.json();
            document.getElementById('status-info').innerHTML = `
                Автозапуск: ${data.enabled ? 'Включен' : 'Выключен'}<br>
                Планировщик: ${data.scheduler_running ? 'Работает' : 'Остановлен'}<br>
                Следующий запуск: ${data.next_run}<br>
                Задач в очереди: ${data.jobs_count}<br>
                Файл отчета: ${data.file_size} байт, ${data.file_date}
            `;
        }
        loadStatus();
        setInterval(loadStatus, 5000);

        document.getElementById('clearSchedule').onclick = async () => {
            if (!confirm('Удалить расписание? Автозапуск будет отключен.')) return;

            const formData = new FormData();
            formData.append('enabled', false);
            formData.append('day', 0);
            formData.append('hour', 10);
            formData.append('minute', 0);

            const resp = await fetch('/schedule', {method: 'POST', body: formData});
            const data = await resp.json();
            document.getElementById('status').innerHTML = `<div style="background: #f8d7da; color: #721c24; padding: 10px; border-radius: 5px;">${data.message}</div>`;

            // Обновляем форму
            document.getElementById('enabled').checked = false;
        }
    </script>
</body>
</html>